<!DOCTYPE html>
<html>
<head>
    <title>PASSNYC</title>
    {# remove favicon.ico error in chrome.#}
    <link rel="shortcut icon" href="#"/>
    <!--    <script src="http://d3js.org/d3.v4.min.js" charset="utf-8"></script>-->
    <script src="{{ url_for('static',filename='js/d3.v4.min.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static',filename='js/jquery-3.6.0.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static',filename='js/BiPlot.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static',filename='js/barchart.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static',filename='js/pcp.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static',filename='js/ScatterOne.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static',filename='js/ScatterTwo.js') }}" charset="utf-8"></script>
    <script src="{{ url_for('static',filename='js/barchart_update.js') }}" charset="utf-8"></script>

    <style>
        .tooltip {
            position: absolute;
            z-index: 10;
            text-align: center;
            max-width: 150px;
            font-size: 14px;
            /*background: white;*/
            color: white;
            /* pointer-events: none; */
        }

        .background path {
            fill: none;
            stroke: #ddd;
            shape-rendering: crispEdges;
        }

        .foreground path {
            fill: none;
            /* stroke: steelblue; */
        }

        .brush .extent {
            fill-opacity: .3;
            stroke: #fff;
            shape-rendering: crispEdges;
        }

        .text_title {
            position: absolute;
            width: 500px;
            z-index: 1000;
            top: 5px;
            font-size: 16px;
            left: 50%;
            transform: translate(-50%, 0);
            text-align: center;
        }

        .scatterplot_div {
            position: absolute;
            top: 50px;
            left: 0px;
        }

        .barchart_div {
            position: absolute;
            top: 50px;
            left: 1280px;
        }

        .biplot_div {
            position: absolute;
            top: 470px;
            left: 0px;
        }

        .scatterplot2_div {
            position: absolute;
            top: 50px;
            left: 640px;
        }

        .pcp_div {
            position: absolute;
            top: 470px;
            left: 640px;
        }

        /*below for dark bg*/
        body {
            background-color: black;
        }

        .x.axis line {
            stroke: white;
        }

        .x.axis path {
            stroke: white;
        }

        .x.axis text {
            fill: white;
        }

        .y.axis line {
            stroke: white;
        }

        .y.axis path {
            stroke: white;
        }

        .y.axis text {
            fill: white;
        }

        .x-axis line {
            stroke: white;
        }

        .x-axis path {
            stroke: white;
        }

        .x-axis text {
            fill: white;
        }

        .y-axis line {
            stroke: white;
        }

        .y-axis path {
            stroke: white;
        }

        .y-axis text {
            fill: white;
        }

        .axis line {
            stroke: white;
        }

        .axis path {
            stroke: white;
        }

        .axis text {
            fill: white;
        }

        text {
            fill: white;
        }

        .text_title {
            width: 100%;
            background: white;
        }

        /*button {*/
        /*    background: none;*/
        /*    border: none;*/
        /*    !*outline: delete the border when chosen.*!*/
        /*    outline: none;*/
        /*    !*border-radius: 12px;*!*/
        /*    !*font-size: 25px;*!*/
        /*    !*position: relative;*!*/
        /*    !*top: 15px;*!*/
        /*    transition-duration: 0.3s;*/
        /*}*/

        /*button:hover {*/
        /*    background-color: gray;*/
        /*    color: white;*/
        /*}*/

    </style>

<body>

<div class="scatterplot_div">
    <svg width="640" height="420" id="scattersvg" class="svgs"></svg>
</div>

<div class="biplot_div">
    <svg width="640" height="420" id="biplotsvg" class="svgs"></svg>
</div>

<div class="barchart_div">
    <svg width="640" height="420" id="barchartsvg" class="svgs"></svg>
</div>

<div class="scatterplot2_div">
    <svg width="640" height="420" id="scattersvg2" class="svgs"></svg>
</div>

<div class="pcp_div">
    <svg width="1280" height="420" id="pcpsvg" class="svgs"></svg>
</div>

<div class="text_title" id="text_title">
    PASSNYC: Specilized High School in NYC
    <button id="button_reset">Reset</button>

</div>

</body>


</head>
<body>
<script>
    const scattersvg = d3.select('#scattersvg');
    const width = +scattersvg.attr('width');
    const height = +scattersvg.attr('height');
    const margin = {top: 50, right: 50, bottom: 50, left: 50};
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;
    const pcpinnerWidth = width * 2 - margin.left - margin.right;

    const biplotsvg = d3.select('#biplotsvg');
    // const barchartsvg = d3.select('#barchartsvg');
    const scattersvg2 = d3.select('#scattersvg2');
    const pcpsvg = d3.select('#pcpsvg');

    var button_1 = document.getElementById("button_reset");
    button_1.onclick = function button1_test() {
        console.log("I am button 1");
        d3.selectAll("svg > *").remove();
        $("div.tooltip").remove();
        plot_init();

    }
    const city_color = {
        'New York': 'aqua',
        'Bronx': 'blue',
        'Brooklyn': 'fuchsia',
        'Flushing': '#5F9EA0',
        'Jamaica': 'green',
        'Long Island': 'lime',
        'Staten Island': 'maroon'
    }

    const col_abbr = {
        'City': 'City',
        'Economic Need Index': 'ENI',
        'School Income Estimate': 'SIE',
        'Percent ELL': 'PELL',
        'Student Attendance Rate': 'SAR',
        'Percent of Students Chronically Absent': 'PSCA',
        'Rigorous Instruction %': 'RI',
        'Rigorous Instruction Rating': 'RIR',
        'Collaborative Teachers %': 'CT',
        'Collaborative Teachers Rating': 'CTR',
        'Supportive Environment %': 'SE',
        'Supportive Environment Rating': 'SER',
        'Effective School Leadership %': 'ESL',
        'Effective School Leadership Rating': 'ESLR',
        'Strong Family-Community Ties %': 'SFCT',
        'Strong Family-Community Ties Rating': 'SFCTR',
        'Trust %': 'TS',
        'Trust Rating': 'TSR',
        'Student Achievement Rating': 'SAR',
        'Average ELA Proficiency': 'AELAP',
        'Average Math Proficiency': 'AMP',
        'Average Proficiency': 'AP',
    }

    function plot_init() {

        scattersvg.append('g')
            .append('text')
            .attr('x', width / 2)
            .attr('y', margin.top / 2)
            .attr('font-size', 18)
            .attr('fill', 'black')
            .attr('text-anchor', 'middle')
            .attr('id', "scattercaption")
            .text('Scatterplot');

        biplotsvg.append('g')
            .append('text')
            .attr('x', width / 2)
            .attr('y', margin.top / 2)
            .attr('font-size', 18)
            .attr('fill', 'black')
            .attr('text-anchor', 'middle')
            .attr('id', "biplotcaption")
            .text('Biplot');

        // barchartsvg.append('g')
        //     .append('text')
        //     .attr('x', width / 2)
        //     .attr('y', margin.top / 2)
        //     .attr('font-size', 18)
        //     .attr('fill', 'black')
        //     .attr('text-anchor', 'middle')
        //     .attr('id', "barchartcaption")
        //     .text('Barchart');

        scattersvg2.append('g')
            .append('text')
            .attr('x', width / 2)
            .attr('y', margin.top / 2)
            .attr('font-size', 18)
            .attr('fill', 'black')
            .attr('text-anchor', 'middle')
            .attr('id', "scatterplot2caption")
            .text('Scatterplot2');

        pcpsvg.append('g')
            .append('text')
            .attr('x', width)
            .attr('y', margin.top / 2)
            .attr('font-size', 18)
            .attr('fill', 'black')
            .attr('text-anchor', 'middle')
            .attr('id', "pcpcaption")
            .text('PCP');

        //below call functions to draw.
        biPlot();
        scatterOne();
        scatterTwo();
        barchart();
        pcp();

        brush_flag_scatter = [];
        brush_flag_barchart = [];
        brush_flag_pcp = [];
        brush_flag_scatter_two = [];
        brush_flag_biplot=[];

    }

    var city_pcp;
    var brush_flag_scatter = [];
    var brush_flag_barchart = [];
    var brush_flag_pcp = [];
    var brush_flag_scatter_two = [];
    var brush_flag_biplot=[];
    plot_init();

    //below for brush update.
    function update_pcp(plot_id, brush_flag) {
        var one_plot = d3.select(plot_id).select("#subgroup>g.foreground").selectAll("path");
        one_plot.style("display", function (d, i) {
            if (brush_flag[i] > 0) {
                return null;
            } else {
                return 'none';
            }
        })
    }

    function update_scatterplot(plot_id, brush_flag) {
        var one_plot = d3.select(plot_id).selectAll("circle");
        one_plot.style("fill", function (d, i) {
            if (brush_flag[i] > 0) {
                return city_color[d[2]];
            } else {
                return 'gray';
            }
        })
    }

    function merge_global_brush() {
        var brush_merge = [];
        for (let k = 0; k < brush_flag_scatter.length; k++) {
            var in_brush_merge = brush_flag_scatter[k] && brush_flag_barchart[k]
                && brush_flag_pcp[k] && brush_flag_scatter_two[k]&&brush_flag_biplot[k];
            if (in_brush_merge) {
                brush_merge.push(1);
            } else {
                brush_merge.push(0);
            }
        }
        return brush_merge;
    }

    function update(dataArray,brush_flag_global,x,y) {
        //1: in brush,0: out of brush.
        var brush_flag = [];
        var extent = d3.event.selection;
        for (let i = 0; i < dataArray.length; i++) {
            var in_brush = isBrushed(extent, x(dataArray[i][0]), y(dataArray[i][1]));
            if (in_brush) {
                brush_flag.push(1);
            } else {
                brush_flag.push(0);
            }
        }
        // console.log(extent)
        console.log('kk')
        // console.log(arr_flag)
        //below is the way to pass global variable as function parameter.
        //can't use it directly, since it would pass value only.
        window[brush_flag_global] = brush_flag;
        // brush_flag_scatter= brush_flag;

        var brush_final = merge_global_brush();

        update_scatterplot("#scattersvg", brush_final);
        update_scatterplot("#scattersvg2", brush_final);
        update_scatterplot("#biplotsvg", brush_final);
        update_pcp("#pcpsvg", brush_final);

        //below for bar chart brush update.
        //count the out of brush data number of each city.
        var city_dict = {};
        var city_list = ["Brooklyn", "Bronx", "New York", "Staten Island", "Jamaica", "Flushing", "Long Island"];
        for (let k = 0; k < city_list.length; k++) {
            city_dict[city_list[k]] = 0;
        }
        for (let p = 0; p < dataArray.length; p++) {
            let one_record_flag = brush_final[p];
            if (one_record_flag == 1) {
                let city_label = dataArray[p][2];
                city_dict[city_label] = city_dict[city_label] + 1;
            }
        }
        var city_data = [];
        for (let city_key in city_dict) {
            city_data.push({'city': city_key, 'num': city_dict[city_key]});
        }
        // console.log(city_num_list)
        barchart_update(city_data);

        // var one_plot = d3.select("#barchartsvg").selectAll("rect");
        // one_plot.attr("y", function (d,i) {
        //     return yscale_barchart(d['num']-city_num_list[i]);
        // });
        // one_plot.attr("height", function (d,i) {
        //     return innerheight_barchart - yscale_barchart(d['num']-city_num_list[i]);
        // });
        // one_plot.on("mouseover", function (d, i) {
        //     // tooltip.html(d['num'])
        //     tooltip_barchart.html(d['num'] - city_num_list[i]);
        // });
    }


    function isBrushed(brush_coords, cx, cy) {
            var x0 = brush_coords[0][0],
                x1 = brush_coords[1][0],
                y0 = brush_coords[0][1],
                y1 = brush_coords[1][1];
            return x0 <= cx && cx <= x1 && y0 <= cy && cy <= y1;
            // This return TRUE or FALSE depending on if the points is in the selected area
        }



</script>
</body>
</html>